generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique
  name          String
  password      String
  phone         String?
  address       String?
  role          Role      @default(CUSTOMER)
  avatar        String?
  isActive      Boolean   @default(true)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  orders        Order[]
  payments      Payment[]
  shippingAddresses ShippingAddress[]
  carts         Cart[]
  reviews       Review[]
  wishlist      Wishlist[]

  @@map("users")
}

model Category {
  id          Int       @id @default(autoincrement())
  name        String
  description String?
  slug        String    @unique
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  products    Product[]

  @@map("categories")
}

model Product {
  id           Int       @id @default(autoincrement())
  name         String
  description  String?
  slug         String    @unique
  price        Decimal   @db.Decimal(15, 2)
  year         Int
  transmission Transmission
  fuelType     FuelType
  mileage      Int
  color        String
  stock        Int       @default(0)
  images       Json
  isActive     Boolean   @default(true)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  categoryId   Int
  category     Category  @relation(fields: [categoryId], references: [id])

  orderItems   OrderItem[]
  cartItems    CartItem[]
  reviews      Review[]
  wishlistItems WishlistItem[]

  @@map("products")
}

model Order {
  id          Int         @id @default(autoincrement())
  orderNumber String      @unique
  userId      Int
  user        User        @relation(fields: [userId], references: [id])
  totalAmount Decimal     @db.Decimal(15, 2)
  status      OrderStatus @default(PENDING)
  notes       String?
  shippingAddress String
  couponId    Int?
  coupon      Coupon?     @relation(fields: [couponId], references: [id])
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  items       OrderItem[]
  payments    Payment[]

  @@map("orders")
}

model OrderItem {
  id          Int     @id @default(autoincrement())
  orderId     Int
  order       Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   Int
  product     Product @relation(fields: [productId], references: [id])
  quantity    Int     @default(1)
  price       Decimal @db.Decimal(15, 2)

  @@map("order_items")
}

model Payment {
  id            Int           @id @default(autoincrement())
  orderId       Int
  order         Order         @relation(fields: [orderId], references: [id])
  userId        Int
  user          User          @relation(fields: [userId], references: [id])
  amount        Decimal       @db.Decimal(15, 2)
  method        PaymentMethod
  status        PaymentStatus @default(PENDING)
  xenditId      String?       @unique
  xenditInvoiceUrl String?
  metadata      Json?
  paidAt        DateTime?
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  @@map("payments")
}

// Shopping Cart Models
model Cart {
  id        Int        @id @default(autoincrement())
  userId    Int        @unique
  user      User       @relation(fields: [userId], references: [id])
  items     CartItem[]
  updatedAt DateTime   @updatedAt

  @@map("carts")
}

model CartItem {
  id        Int      @id @default(autoincrement())
  cartId    Int
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId Int
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int      @default(1)

  @@unique([cartId, productId])
  @@map("cart_items")
}

// Product Reviews
model Review {
  id        Int       @id @default(autoincrement())
  productId Int
  product   Product   @relation(fields: [productId], references: [id])
  userId    Int
  user      User      @relation(fields: [userId], references: [id])
  rating    Int       // 1-5
  comment   String?
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([productId, userId])
  @@map("reviews")
}

// Wishlist
model Wishlist {
  id        Int       @id @default(autoincrement())
  userId    Int       @unique
  user      User      @relation(fields: [userId], references: [id])
  items     WishlistItem[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("wishlists")
}

model WishlistItem {
  id         Int      @id @default(autoincrement())
  wishlistId Int
  wishlist   Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  productId  Int
  product    Product  @relation(fields: [productId], references: [id])

  @@unique([wishlistId, productId])
  @@map("wishlist_items")
}

// Coupons
model Coupon {
  id           Int           @id @default(autoincrement())
  code         String        @unique
  discountType DiscountType
  value        Decimal       @db.Decimal(10, 2)
  minPurchase  Decimal?      @db.Decimal(15, 2)
  maxDiscount  Decimal?      @db.Decimal(15, 2)
  startDate    DateTime
  endDate      DateTime
  usageLimit   Int?
  usedCount    Int           @default(0)
  isActive     Boolean       @default(true)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  orders       Order[]

  @@map("coupons")
}

// Shipping Addresses
model ShippingAddress {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id])
  label      String   // "Rumah", "Kantor", "Alamat Utama"
  recipient  String
  phone      String
  address    String
  city       String
  province   String
  postalCode String
  isPrimary  Boolean  @default(false)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@map("shipping_addresses")
}

enum Role {
  ADMIN
  CUSTOMER
}

enum Transmission {
  MANUAL
  AUTOMATIC
  SEMI_AUTOMATIC
}

enum FuelType {
  GASOLINE
  DIESEL
  ELECTRIC
  HYBRID
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentMethod {
  BANK_TRANSFER
  E_WALLET
  CREDIT_CARD
  VIRTUAL_ACCOUNT
}

enum PaymentStatus {
  PENDING
  PAID
  EXPIRED
  FAILED
}

enum DiscountType {
  PERCENTAGE
  FIXED_AMOUNT
}